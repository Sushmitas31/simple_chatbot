{% extends "base.html" %}

{% block title %}Chat - AI Chatbot{% endblock %}

{% block content %}
<div class="chat-container">
    {% if current_chat %}
    <!-- Chat Messages Area -->
    <div class="messages-container" id="messagesContainer">
        <div class="chat-header">
            <h4><i class="bi bi-chat-dots me-2"></i>{{ current_chat.title }}</h4>
        </div>
        
        <div class="messages-area" id="messagesArea">
            {% if messages %}
                {% for message in messages %}
                <div class="message {{ 'user-message' if message.is_user else 'ai-message' }}">
                    <div class="message-avatar">
                        {% if message.is_user %}
                            <i class="bi bi-person-circle"></i>
                        {% else %}
                            <i class="bi bi-robot"></i>
                        {% endif %}
                    </div>
                    <div class="message-content">
                        <div class="message-text">{{ message.content }}</div>
                        <div class="message-time">{{ message.timestamp.strftime('%I:%M %p') }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="welcome-message">
                    <div class="text-center">
                        <i class="bi bi-robot welcome-icon"></i>
                        <h3>Hello! I'm your AI assistant</h3>
                        <p class="text-muted">Ask me anything to get started with our conversation.</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Message Input Area -->
    <div class="input-container">
        <form id="messageForm" class="message-form">
            <div class="input-group">
                <input type="text" class="form-control message-input" id="messageInput" 
                       placeholder="Type your message here..." autocomplete="off" required>
                <button class="btn btn-primary send-btn" type="submit" id="sendButton">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </form>
    </div>
    
    {% else %}
    <!-- Welcome Screen -->
    <div class="welcome-screen">
        <div class="text-center">
            <i class="bi bi-robot welcome-icon"></i>
            <h2>Welcome to AI Chatbot</h2>
            <p class="text-muted mb-4">Start a new conversation or select an existing chat from the sidebar.</p>
            <button class="btn btn-primary btn-lg" id="startNewChatBtn">
                <i class="bi bi-plus-lg me-2"></i>Start New Chat
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">AI is thinking...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentChatId = {{ current_chat.id if current_chat else 'null' }};

// DOM Elements
const messageForm = document.getElementById('messageForm');
const messageInput = document.getElementById('messageInput');
const messagesArea = document.getElementById('messagesArea');
const sendButton = document.getElementById('sendButton');
const loadingOverlay = document.getElementById('loadingOverlay');
const newChatBtn = document.getElementById('newChatBtn');
const startNewChatBtn = document.getElementById('startNewChatBtn');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // Focus on message input if chat is active
    if (currentChatId && messageInput) {
        messageInput.focus();
    }
});

// Handle new chat creation
if (newChatBtn) {
    newChatBtn.addEventListener('click', createNewChat);
}

if (startNewChatBtn) {
    startNewChatBtn.addEventListener('click', createNewChat);
}

// Handle message form submission
if (messageForm) {
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
}

// Handle chat item clicks
document.addEventListener('click', function(e) {
    if (e.target.closest('.chat-item')) {
        const chatItem = e.target.closest('.chat-item');
        const chatId = chatItem.dataset.chatId;
        if (chatId && chatId !== String(currentChatId)) {
            window.location.href = `/chat/${chatId}`;
        }
    }
    
    // Handle delete chat buttons
    if (e.target.closest('.delete-chat-btn')) {
        e.stopPropagation();
        const chatId = e.target.closest('.delete-chat-btn').dataset.chatId;
        deleteChat(chatId);
    }
});

function createNewChat() {
    const firstMessage = messageInput ? messageInput.value.trim() : '';
    const title = firstMessage ? firstMessage.substring(0, 30) + '...' : 'New Chat';
    
    showLoading();
    
    fetch('/new_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ title: title })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        window.location.href = `/chat/${data.chat_id}`;
    })
    .catch(error => {
        hideLoading();
        console.error('Error creating new chat:', error);
        alert('Failed to create new chat. Please try again.');
    });
}

function sendMessage() {
    if (!currentChatId) {
        createNewChat();
        return;
    }
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Disable input and show loading
    messageInput.disabled = true;
    sendButton.disabled = true;
    showLoading();
    
    // Add user message to UI immediately
    addMessageToUI(message, true);
    messageInput.value = '';
    
    // Send message to server
    fetch('/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_id: currentChatId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Add AI response to UI
        addMessageToUI(data.ai_response, false);
    })
    .catch(error => {
        hideLoading();
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
        
        console.error('Error sending message:', error);
        addMessageToUI('Sorry, I encountered an error. Please try again.', false, true);
    });
}

function addMessageToUI(content, isUser, isError = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}${isError ? ' error-message' : ''}`;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${isUser ? '<i class="bi bi-person-circle"></i>' : '<i class="bi bi-robot"></i>'}
        </div>
        <div class="message-content">
            <div class="message-text">${escapeHtml(content)}</div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    // Remove welcome message if it exists
    const welcomeMessage = messagesArea.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
    
    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function deleteChat(chatId) {
    if (!confirm('Are you sure you want to delete this chat?')) {
        return;
    }
    
    fetch(`/delete_chat/${chatId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // If we're deleting the current chat, redirect to main chat page
            if (String(chatId) === String(currentChatId)) {
                window.location.href = '/chat';
            } else {
                // Just remove the chat item from the sidebar
                const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (chatItem) {
                    chatItem.remove();
                }
            }
        } else {
            alert('Failed to delete chat. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error deleting chat:', error);
        alert('Failed to delete chat. Please try again.');
    });
}

function showLoading() {
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
}

function hideLoading() {
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

function scrollToBottom() {
    if (messagesArea) {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-resize textarea and handle enter key
if (messageInput) {
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}
</script>
{% endblock %}
